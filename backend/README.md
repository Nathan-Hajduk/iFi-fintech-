# iFi Backend

Production-ready Node.js/Express backend for iFi financial platform with Plaid integration.

## Features

- ✅ **Plaid Integration** - Secure bank account connections
- ✅ **AES-256 Encryption** - Encrypted access token storage
- ✅ **Rate Limiting** - Protection against abuse
- ✅ **Security Headers** - Helmet.js configured
- ✅ **PostgreSQL Database** - Robust data storage
- ✅ **Transaction Sync** - Automatic transaction updates
- ✅ **Webhook Handler** - Real-time Plaid notifications
- ✅ **Error Handling** - Comprehensive error management
- ✅ **Logging** - Request/error logging with Morgan

## Prerequisites

- **Node.js** 18.0.0 or higher
- **PostgreSQL** 13.0 or higher
- **Plaid Account** (free sandbox available at https://dashboard.plaid.com/)

## Quick Start

### 1. Install Dependencies

```bash
cd backend
npm install
```

### 2. Set Up Environment

Run the setup script to generate secure keys:

```bash
node setup.js
```

Or manually copy the example file:

```bash
cp .env.example .env
```

### 3. Configure Environment Variables

Edit `.env` file:

```env
# Get these from https://dashboard.plaid.com/
PLAID_CLIENT_ID=your_sandbox_client_id_here
PLAID_SECRET=your_sandbox_secret_here
PLAID_ENV=sandbox

# Database (ensure PostgreSQL is running)
DB_HOST=localhost
DB_PORT=5432
DB_NAME=ifi_db
DB_USER=ifi_user
DB_PASSWORD=your_secure_password

# Other settings are auto-generated by setup.js
```

### 4. Create Database

```bash
# Using PostgreSQL command line
createdb ifi_db

# Or using psql
psql -U postgres
CREATE DATABASE ifi_db;
CREATE USER ifi_user WITH PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE ifi_db TO ifi_user;
\q
```

### 5. Start Server

```bash
# Production mode
npm start

# Development mode (with auto-reload)
npm run dev
```

The server will automatically:
- Test database connection
- Create required tables
- Start listening on port 3000

## API Endpoints

### Plaid Integration

#### Create Link Token
```http
POST /api/plaid/create_link_token
Content-Type: application/json

{
  "userId": "123"
}
```

**Response:**
```json
{
  "success": true,
  "link_token": "link-sandbox-abc123...",
  "expiration": "2024-01-15T10:30:00Z"
}
```

#### Exchange Public Token
```http
POST /api/plaid/exchange_public_token
Content-Type: application/json

{
  "public_token": "public-sandbox-xyz789...",
  "userId": "123",
  "accounts": [...],
  "institution": {...}
}
```

**Response:**
```json
{
  "success": true,
  "item_id": "item_abc123",
  "institution": "Chase",
  "accounts": 2,
  "message": "Bank connection established successfully"
}
```

#### Get User Connections
```http
GET /api/plaid/connections/:userId
```

#### Sync Transactions
```http
POST /api/plaid/sync/:itemId
Content-Type: application/json

{
  "startDate": "2024-01-01",
  "endDate": "2024-01-31"
}
```

#### Webhook Handler
```http
POST /api/plaid/webhook
Plaid-Verification: <signature>

{
  "webhook_type": "TRANSACTIONS",
  "webhook_code": "DEFAULT_UPDATE",
  "item_id": "item_abc123"
}
```

#### Remove Connection
```http
DELETE /api/plaid/connection/:itemId
```

### Health Check

```http
GET /health
```

## Testing

### With Plaid Sandbox

Use these test credentials in Plaid Link:

- **Username:** `user_good`
- **Password:** `pass_good`
- **Bank:** Any test institution (e.g., "First Platypus Bank")

### Test Flow

1. Start backend: `npm start`
2. Open frontend: `http://localhost:3000/html/onboarding.html`
3. Complete Step 1 (Purpose)
4. Click "Connect Bank Account"
5. Select test bank
6. Login with test credentials
7. Select accounts
8. Verify success message

### Using cURL

```bash
# Create link token
curl -X POST http://localhost:3000/api/plaid/create_link_token \
  -H "Content-Type: application/json" \
  -d '{"userId":"123"}'

# Health check
curl http://localhost:3000/health
```

## Database Schema

### Tables

**users**
- id, email, password_hash, first_name, last_name, created_at, updated_at

**plaid_connections**
- id, user_id, item_id, access_token (encrypted), institution_id, institution_name, accounts (JSONB), status, last_synced_at, created_at, updated_at

**transactions**
- id, user_id, plaid_connection_id, transaction_id, account_id, amount, date, name, merchant_name, category, subcategory, pending, payment_channel, created_at, updated_at

### Indexes
- Fast user lookups
- Date range queries
- Transaction categorization

## Security

### Encryption
- Access tokens encrypted with AES-256-CBC
- 32-byte encryption key (auto-generated)
- Unique IV per encrypted value

### Rate Limiting
- API: 100 requests / 15 minutes
- Plaid: 50 requests / 15 minutes
- Auth: 5 requests / 15 minutes

### Headers (Helmet.js)
- Content Security Policy
- HSTS (1 year)
- XSS Protection
- Frame Guard (clickjacking prevention)
- MIME Sniffing protection

### CORS
- Configurable allowed origins
- Credentials support
- Preflight caching

### Webhook Verification
- HMAC-SHA256 signature validation
- Prevents unauthorized webhook calls

## Error Handling

All errors return consistent JSON format:

```json
{
  "error": "Error Name",
  "message": "Human-readable description",
  "details": {}
}
```

### Common Errors

- **400** - Validation Error
- **401** - Invalid/Expired Token
- **403** - CORS Error
- **404** - Not Found
- **429** - Rate Limit Exceeded
- **500** - Internal Server Error

## Monitoring

### Logs

Production logs in `logs/app.log`:
- HTTP requests (Morgan)
- Database queries
- Plaid API calls
- Errors with stack traces

### Health Check

```bash
curl http://localhost:3000/health
```

Returns:
- Server status
- Uptime
- Environment
- Version

## Development

### Project Structure

```
backend/
├── config/
│   └── database.js          # PostgreSQL connection pool
├── middleware/
│   └── security.js          # Rate limiting, CORS, Helmet
├── routes/
│   └── plaidRoutes.js       # Plaid API endpoints
├── services/
│   └── plaidService.js      # Plaid business logic
├── utils/
│   └── encryption.js        # Encryption utilities
├── logs/                     # Application logs
├── .env                      # Environment config (git-ignored)
├── .env.example              # Template
├── package.json
├── server.js                 # Main application
└── setup.js                  # Setup wizard
```

### Adding New Endpoints

1. Create route in `routes/`
2. Add business logic in `services/`
3. Register route in `server.js`
4. Update this README

### Database Migrations

```javascript
// scripts/migrate.js
const db = require('./config/database');

async function migrate() {
  await db.initializeTables();
  // Add migration logic here
}

migrate();
```

## Production Deployment

### Environment Variables

```env
NODE_ENV=production
PLAID_ENV=production
PLAID_CLIENT_ID=production_client_id
PLAID_SECRET=production_secret
```

### SSL/HTTPS

Recommended: Use reverse proxy (Nginx) with Let's Encrypt

```nginx
server {
  listen 443 ssl http2;
  server_name api.yourdomain.com;
  
  ssl_certificate /path/to/cert.pem;
  ssl_certificate_key /path/to/key.pem;
  
  location / {
    proxy_pass http://localhost:3000;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_cache_bypass $http_upgrade;
  }
}
```

### Process Manager

Use PM2 for production:

```bash
npm install -g pm2

# Start
pm2 start server.js --name ifi-backend

# Monitor
pm2 monit

# Logs
pm2 logs ifi-backend

# Restart
pm2 restart ifi-backend
```

### Database Backups

```bash
# Daily backup
pg_dump ifi_db > backup_$(date +%Y%m%d).sql

# Restore
psql ifi_db < backup_20240115.sql
```

## Troubleshooting

### Database Connection Failed

```bash
# Check PostgreSQL is running
sudo systemctl status postgresql

# Test connection
psql -U ifi_user -d ifi_db

# Reset password
ALTER USER ifi_user WITH PASSWORD 'new_password';
```

### Plaid Errors

- **INVALID_CREDENTIALS**: Check client_id and secret in .env
- **ITEM_LOGIN_REQUIRED**: User needs to re-authenticate
- **PRODUCT_NOT_READY**: Wait 30 seconds for transactions

### Port Already in Use

```bash
# Find process using port 3000
lsof -i :3000

# Kill process
kill -9 <PID>

# Or change port in .env
PORT=3001
```

## Support

- **Documentation**: [PLAID_INTEGRATION_GUIDE.md](../PLAID_INTEGRATION_GUIDE.md)
- **Plaid Docs**: https://plaid.com/docs/
- **Plaid Dashboard**: https://dashboard.plaid.com/

## License

MIT

---

**Built with ❤️ for the iFi Platform**
